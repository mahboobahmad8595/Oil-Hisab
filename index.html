<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oil Hisab</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>


<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 30px;
}

.container { display: flex; gap: 20px; flex-wrap: wrap; }

.box-size { width: 160px; height: 180px; }

.add-new {
    border: 2px dashed #bbb;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
    background: white;
}
.add-new:hover { border-color: #4CAF50; }

.plus-icon { font-size: 45px; color: #4CAF50; font-weight: bold; }

.cards {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
    transition: 0.2s;
    cursor: pointer;
}
.card:hover { transform: scale(1.03); }

.card-title { font-size: 18px; font-weight: bold; padding: 5px 0; }

.menu-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    font-size: 22px;
    cursor: pointer;
    padding: 3px;
}

.menu-popup {
    position: absolute;
    bottom: 35px;
    right: 5px;
    background: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    border-radius: 8px;
    padding: 5px 0;
    display: none;
    width: 120px;
    z-index: 10;
}
.menu-item { padding: 8px 12px; cursor: pointer; }
.menu-item:hover { background: #f0f0f0; }

.rename-input { width: 100%; font-size: 17px; padding: 5px; }
</style>
</head>

<body>

<div class="container">

    <div class="add-new box-size" id="addNewBtn">
        <div class="plus-icon">+</div>
        <p>Add New</p>
    </div>

    <div class="cards" id="cardsContainer"></div>

</div>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyA4_2-SVgh73vmIQI0YBhSNdh4MFd0F7No",
  authDomain: "oil-hisab.firebaseapp.com",
  databaseURL: "https://oil-hisab-default-rtdb.firebaseio.com",
  projectId: "oil-hisab",
  storageBucket: "oil-hisab.appspot.com",
  messagingSenderId: "170082816384",
  appId: "1:170082816384:web:29e99b4ed0f5147e66f165"
};


// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

function saveCardToFirebase(id, title) {
    database.ref("cards/" + id).set({
        title: title
    });
}


function loadCardsFromFirebase() {
    database.ref("cards").on("value", snapshot => {
        cardsContainer.innerHTML = "";

        const data = snapshot.val() || {};
        Object.keys(data).forEach(id => {
            createCard(id, data[id].title);
        });
    });
}


// Function to save owner record
function saveRecord(ownerName, record) {
    const ownerKey = ownerName.toLowerCase();
    const newRef = database.ref(`owners/${ownerKey}`).push();
    newRef.set(record);
}

// Function to listen for owner data changes
function listenOwnerData(ownerName, callback) {
    const ownerKey = ownerName.toLowerCase();
    const ref = database.ref(`owners/${ownerKey}`);
    ref.on('value', snapshot => {
        const data = snapshot.val() || {};
        // Convert object to array
        const records = Object.values(data);
        callback(records);
    });
}

const addNewBtn = document.getElementById("addNewBtn");
const cardsContainer = document.getElementById("cardsContainer");

window.onload = loadCardsFromFirebase;


// ADD NEW CARD
addNewBtn.addEventListener("click", () => {
    let id = Date.now();
    createCard(id, "New File");
saveCardToFirebase(id, "New File");

});

function loadOwnerFromOil(ownerName) {
    const page = document.getElementById(ownerName.toLowerCase());
    const table = page.querySelector(".table-grid");

    // Clear table rows
    while (table.children.length > 5) table.removeChild(table.lastChild);

    listenOwnerData(ownerName, ownerData => {
        let totalLitre = 0;

        ownerData.forEach(record => {
            totalLitre += parseFloat(record.litre || 0);

            const formattedDate = formatDateToDDMMYYYY(record.date);
            const rowData = [
                record.memo || "",
                record.drum || "",
                formattedDate,
                record.vehicle || "",
                record.litre || ""
            ];

            rowData.forEach(value => {
                const cell = document.createElement("div");
                cell.className = "cell input-cell";
                cell.textContent = value;
                table.appendChild(cell);
            });
        });

        updateOwnerSummary(ownerName.toLowerCase(), ownerName, totalLitre, ownerData.length);

        if (ownerData.length === 0) {
            const messageCell = document.createElement("div");
            messageCell.style.gridColumn = "1 / span 5";
            messageCell.style.textAlign = "center";
            messageCell.style.padding = "20px";
            messageCell.style.color = "#666";
            messageCell.textContent = `No oil records found for ${ownerName}`;
            table.appendChild(messageCell);
        }
    });
}

function addNewEntry(ownerName, memo, drum, date, vehicle, litre) {
    const record = {
        memo,
        drum,
        date,
        vehicle,
        litre
    };
    saveRecord(ownerName, record);
}


// CREATE CARD
function createCard(id, titleText) {
    const card = document.createElement("div");
    card.className = "card box-size";
    card.setAttribute("data-id", id);

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = titleText;

    // Card click → Open files
    card.addEventListener("click", (e) => {
        if (e.target.classList.contains("menu-btn") ||
            e.target.classList.contains("menu-item")) return;

        const cardName = encodeURIComponent(card.querySelector(".card-title").textContent);

        // Agar card title 'Owner' ho → owner.html
        const currentTitle = card.querySelector(".card-title").textContent.toLowerCase();

if (currentTitle === "owner") {
    window.location.href = `pages/owner.html?id=${id}&name=${cardName}`;
}
else if (currentTitle === "oil") {
    window.location.href = `pages/oil.html?id=${id}&name=${cardName}`;
}
else if (currentTitle === "summary") {
    window.location.href = `pages/summary.html?id=${id}&name=${cardName}`;
}
else {
    window.location.href = `pages/dashboard.html?id=${id}&name=${cardName}`;
}

    });

    // MENU BUTTON
    const menuBtn = document.createElement("div");
    menuBtn.className = "menu-btn";
    menuBtn.textContent = "⋮";

    const menuPopup = document.createElement("div");
    menuPopup.className = "menu-popup";

    const renameOption = document.createElement("div");
    renameOption.className = "menu-item";
    renameOption.textContent = "Rename";

    renameOption.addEventListener("click", (e) => {
        e.stopPropagation();
        menuPopup.style.display = "none";

        const latestTitle = card.querySelector(".card-title");
        renameCard(latestTitle, id);
    });

    const deleteOption = document.createElement("div");
    deleteOption.className = "menu-item";
    deleteOption.textContent = "Delete";

   deleteOption.addEventListener("click", () => {
    card.remove();
    database.ref("cards/" + id).remove();
});


    menuPopup.appendChild(renameOption);
    menuPopup.appendChild(deleteOption);

    menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        menuPopup.style.display =
            menuPopup.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", () => menuPopup.style.display = "none");

    card.appendChild(title);
    card.appendChild(menuBtn);
    card.appendChild(menuPopup);

    cardsContainer.appendChild(card);
}

// RENAME
function renameCard(titleElement, id) {
    const currentName = titleElement.textContent;

    const input = document.createElement("input");
    input.type = "text";
    input.value = currentName;
    input.className = "rename-input";

    titleElement.replaceWith(input);
    input.focus();

    input.addEventListener("blur", () => restoreTitle(input, id));
    input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") restoreTitle(input, id);
    });
}

function restoreTitle(input, id) {
    const newTitle = input.value.trim() || "New File";

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = newTitle;

    title.addEventListener("click", () => {
        const cardName = encodeURIComponent(newTitle);
        if (newTitle.toLowerCase() === "owner") {
            window.location.href = `pages/owner.html?id=${id}&name=${cardName}`;
        } else if (newTitle.toLowerCase() === "oil") {
            window.location.href = `pages/oil.html?id=${id}&name=${cardName}`;
        } else if (newTitle.toLowerCase() === "summary") {
        window.location.href = `pages/summary.html?id=${id}&name=${cardName}`;
        }else {
            window.location.href = `pages/dashboard.html?id=${id}&name=${cardName}`;
        }
    });

    input.replaceWith(title);

    
    saveCardToFirebase(id, newTitle);

}




</script>

</body>
</html>
