<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner</title>
</body>
</html>

<style>
*{margin:0;padding:0;box-sizing:border-box;}

body{
    font-family: Arial, sans-serif;
    background:#f4f4f4;
    display:flex;
    justify-content:center;
    padding:12px;
}

.main-box{
    width:92vw;
    max-width:470px;
    background:white;
    border:2px solid #000;
    padding:10px;
    position:relative;
}

/* ========== COMPLETE TABLE FIX ========== */
.table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #ccc;
    margin-top: 10px;
    position: relative;
}

/* Table wrapper for sticky header */
.table-wrapper {
    position: relative;
}

/* Main table grid */
.table-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    width: 100%;
}

/* HEADER FIX - Separate styling */
.header-row {
    display: contents;
}

/* MENU */
.dropdown { 
    position: absolute; 
    top: 10px; 
    right: 10px; 
    z-index: 1000;
}
.dot{
    width:4px; 
    height:4px;
    background:#000;
    border-radius:50%;
    display:block;
    margin:3px 0;
    cursor:pointer;
}
.dropdown-content{
    display:none;
    position:absolute;
    right:0;
    top:15px;
    background:#fff;
    border:1px solid #000;
    z-index:1001;
    font-size:12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    min-width: 120px;
}
.dropdown-content div{ 
    padding:8px 12px; 
    cursor:pointer; 
    white-space: nowrap;
}
.dropdown-content div:hover{ background:#f0f0f0; }

/* PAGES */
.page { 
    display:none; 
    position: relative; 
    padding-bottom: 20px;
}

/* TOP INPUTS */
.top-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:14px 10px;
    margin-bottom:12px;
}
.top-grid > div{
    display:flex;
    flex-direction:column;
    align-items:center;
}
.top-grid span{
    font-size:13px;
    font-weight:bold;
}
.top-grid input{
    width:70%;
    border:none;
    border-bottom:1.3px solid #000;
    background:transparent;
    padding:3px 0;
    text-align:center;
    font-size:14px;
    font-weight:bold;
    outline:none;
}

/* Simple column width adjustment */
.table-grid {
    display: grid;
    grid-template-columns: 15% 15% 27% 27% 15%; /* âœ… Percentage widths */
    /* OR */
    /* grid-template-columns: 70px 50px 100px 100px 70px; Fixed pixels */
}

.table-grid .cell {
    border-right: 2px solid #000;
    border-bottom: 2px solid #000;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12.5px;
    font-weight: bold;
    min-height: 30px;
    padding: 5px 2px;
    word-break: break-word;
}

.input-cell {
    background: #fff;
}

.table-grid .cell:nth-child(-n+5) {
    background: #f0f0f0;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 100;
    border: 2px solid #000 !important;
    border-bottom: 2px solid #000 !important;
}

/* Regular cells */
.table-grid .cell {
    border-right: 2px solid #000;
    border-bottom: 2px solid #000;
    border-left: 2px solid #000;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12.5px;
    font-weight: bold;
    min-height: 30px;
    padding: 5px 2px;
    word-break: break-word;
}


/* Header row styling */
.table-grid .cell:first-child,
.table-grid .cell:nth-child(2),
.table-grid .cell:nth-child(3),
.table-grid .cell:nth-child(4),
.table-grid .cell:nth-child(5) {
    background: #f0f0f0;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* ========== PDF EXPORT BUTTON - BELOW CONTAINER ========== */
.pdf-btn {
    display: block;
    margin: 15px auto 5px auto;
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 120px;
    transition: all 0.3s ease;
}

.pdf-btn:hover {
    background: #c82333;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.cell{
    border-right:2px solid #000;
    border-bottom:2px solid #000;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:12.5px;
    font-weight:bold;
}
.input-cell input{
    width:100%;
    height:100%;
    border:none;
    background:transparent;
    text-align:center;
    font-size:12.5px;
    outline:none;
}
</style>
</head>
<body>

<div class="main-box">

    <!-- ========== ATHAR PAGE ========== -->
    <div id="athar" class="page">
        
        <!-- Dropdown Menu -->
        <div class="dropdown">
            <span class="dot" onclick="toggleDropdown()"></span>
            <span class="dot" onclick="toggleDropdown()"></span>
            <span class="dot" onclick="toggleDropdown()"></span>
            <div class="dropdown-content" id="dropdownMenu">
                <div onclick="openPage('athar','Athar')">Athar</div>
                <div onclick="openPage('sabir','Sabir')">Sabir</div>
                <div onclick="openPage('tahir','Tahir')">Tahir</div>
                <div onclick="openPage('faisal','Faisal')">Faisal</div>
            </div>
        </div>
        
        <!-- Top Input Grid -->
        <div class="top-grid">
            <div><span>Owner:</span><input id="owner-athar" type="text" readonly></div>
            <div><span>Oil Sent On:</span><input type="text"></div>
            <div><span>Oil Usage:</span><input type="text"></div>
            <div><span>Total Litre:</span><input id="total-athar" type="text" readonly></div>
            <div><span>Rate:</span><input id="rate-athar" type="text"></div>
            <div><span>Amount:</span><input id="amount-athar" type="text" readonly></div>
        </div>
        
        <!-- Scrollable Table Container -->
        <div class="table-container">
            <div class="table-grid" id="table-athar">
                <div class="cell">Memo</div>
                <div class="cell">Drum</div>
                <div class="cell">Date</div>
                <div class="cell">Vehicle</div>
                <div class="cell">Litre</div>
                <!-- Rows will be added dynamically here -->
            </div>
        </div>
        
        <!-- PDF Button -->
        <button class="pdf-btn" onclick="exportToPDF('athar', 'Athar')">
            ðŸ“„ Export PDF
        </button>
    </div>

    <!-- ========== SABIR PAGE ========== -->
    <div id="sabir" class="page">
        
        <!-- Dropdown Menu -->
        <div class="dropdown">
            <span class="dot" onclick="toggleDropdown()"></span>
            <span class="dot" onclick="toggleDropdown()"></span>
            <span class="dot" onclick="toggleDropdown()"></span>
            <div class="dropdown-content" id="dropdownMenu">
                <div onclick="openPage('athar','Athar')">Athar</div>
                <div onclick="openPage('sabir','Sabir')">Sabir</div>
                <div onclick="openPage('tahir','Tahir')">Tahir</div>
                <div onclick="openPage('faisal','Faisal')">Faisal</div>
            </div>
        </div>
        
        <!-- Top Input Grid -->
        <div class="top-grid">
            <div><span>Owner:</span><input id="owner-sabir" type="text" readonly></div>
            <div><span>Oil Sent On:</span><input type="text"></div>
            <div><span>Oil Usage:</span><input type="text"></div>
            <div><span>Total Litre:</span><input id="total-sabir" type="text" readonly></div>
            <div><span>Rate:</span><input id="rate-sabir" type="text"></div>
            <div><span>Amount:</span><input id="amount-sabir" type="text" readonly></div>
        </div>
        
        <!-- Scrollable Table Container -->
        <div class="table-container">
            <div class="table-grid" id="table-sabir">
                <div class="cell">Memo</div>
                <div class="cell">Drum</div>
                <div class="cell">Date</div>
                <div class="cell">Vehicle</div>
                <div class="cell">Litre</div>
                <!-- Rows will be added dynamically here -->
            </div>
        </div>
        
        <!-- PDF Button -->
        <button class="pdf-btn" onclick="exportToPDF('sabir', 'Sabir')">
            ðŸ“„ Export PDF
        </button>
    </div>

    <!-- ========== TAHIR PAGE ========== -->
    <div id="tahir" class="page">
        
        <!-- Dropdown Menu -->
        <div class="dropdown">
            <span class="dot" onclick="toggleDropdown()"></span>
            <span class="dot" onclick="toggleDropdown()"></span>
            <span class="dot" onclick="toggleDropdown()"></span>
            <div class="dropdown-content" id="dropdownMenu">
                <div onclick="openPage('athar','Athar')">Athar</div>
                <div onclick="openPage('sabir','Sabir')">Sabir</div>
                <div onclick="openPage('tahir','Tahir')">Tahir</div>
                <div onclick="openPage('faisal','Faisal')">Faisal</div>
            </div>
        </div>
        
        <!-- Top Input Grid -->
        <div class="top-grid">
            <div><span>Owner:</span><input id="owner-tahir" type="text" readonly></div>
            <div><span>Oil Sent On:</span><input type="text"></div>
            <div><span>Oil Usage:</span><input type="text"></div>
            <div><span>Total Litre:</span><input id="total-tahir" type="text" readonly></div>
            <div><span>Rate:</span><input id="rate-tahir" type="text"></div>
            <div><span>Amount:</span><input id="amount-tahir" type="text" readonly></div>
        </div>
        
        <!-- Scrollable Table Container -->
        <div class="table-container">
            <div class="table-grid" id="table-tahir">
                <div class="cell">Memo</div>
                <div class="cell">Drum</div>
                <div class="cell">Date</div>
                <div class="cell">Vehicle</div>
                <div class="cell">Litre</div>
                <!-- Rows will be added dynamically here -->
            </div>
        </div>
        
        <!-- PDF Button -->
        <button class="pdf-btn" onclick="exportToPDF('tahir', 'Tahir')">
            ðŸ“„ Export PDF
        </button>
    </div>

    <!-- ========== FAISAL PAGE ========== -->
    <div id="faisal" class="page">
        
        <!-- Dropdown Menu -->
        <div class="dropdown">
            <span class="dot" onclick="toggleDropdown()"></span>
            <span class="dot" onclick="toggleDropdown()"></span>
            <span class="dot" onclick="toggleDropdown()"></span>
            <div class="dropdown-content" id="dropdownMenu">
                <div onclick="openPage('athar','Athar')">Athar</div>
                <div onclick="openPage('sabir','Sabir')">Sabir</div>
                <div onclick="openPage('tahir','Tahir')">Tahir</div>
                <div onclick="openPage('faisal','Faisal')">Faisal</div>
            </div>
        </div>
        
        <!-- Top Input Grid -->
        <div class="top-grid">
            <div><span>Owner:</span><input id="owner-faisal" type="text" readonly></div>
            <div><span>Oil Sent On:</span><input type="text"></div>
            <div><span>Oil Usage:</span><input type="text"></div>
            <div><span>Total Litre:</span><input id="total-faisal" type="text" readonly></div>
            <div><span>Rate:</span><input id="rate-faisal" type="text"></div>
            <div><span>Amount:</span><input id="amount-faisal" type="text" readonly></div>
        </div>
        
        <!-- Scrollable Table Container -->
        <div class="table-container">
            <div class="table-grid" id="table-faisal">
                <div class="cell">Memo</div>
                <div class="cell">Drum</div>
                <div class="cell">Date</div>
                <div class="cell">Vehicle</div>
                <div class="cell">Litre</div>
                <!-- Rows will be added dynamically here -->
            </div>
        </div>
        
        <!-- PDF Button -->
        <button class="pdf-btn" onclick="exportToPDF('faisal', 'Faisal')">
            ðŸ“„ Export PDF
        </button>
    </div>

</div>

<script>
/* ========== DATE FORMAT FUNCTION ========== */
function formatDateToDDMMYYYY(dateString) {
    if (!dateString) return "";
    
    const parts = dateString.split('-');
    if (parts.length === 3) {
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
    return dateString;
}

/* ========== LOAD OWNER DATA WITH UNLIMITED ROWS ========== */
function loadOwnerFromOil(ownerName) {
    const params = new URLSearchParams(window.location.search);
    const fileID = params.get("id") || "default";
    const masterKey = `oilOwnerMaster_${fileID}`;
    
    const masterData = JSON.parse(localStorage.getItem(masterKey)) || [];
    const page = document.getElementById(ownerName.toLowerCase());
    
    if (!page) {
        console.error("Page not found for owner:", ownerName);
        return;
    }
    
    const table = page.querySelector(".table-grid");
    const ownerId = ownerName.toLowerCase();
    
    // Clear existing rows (keep only 5 header cells)
    while (table.children.length > 5) {
        table.removeChild(table.lastChild);
    }
    
    // Filter data for this owner
    const ownerData = masterData.filter(record => 
        record.owner && record.owner.toLowerCase() === ownerName.toLowerCase()
    );
    
    // Sort by date (newest first)
    ownerData.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let totalLitre = 0;
    
    // Add data rows - UNLIMITED based on data
    ownerData.forEach(record => {
        totalLitre += parseFloat(record.litre) || 0;
        
        // Format date
        const formattedDate = formatDateToDDMMYYYY(record.date);
        
        // Create row cells
        const rowData = [
            record.memo || "",
            record.drum || "",
            formattedDate,
            record.vehicle || "",
            record.litre || ""
        ];
        
        rowData.forEach(value => {
            const cell = document.createElement("div");
            cell.className = "cell input-cell";
            cell.textContent = value;
            table.appendChild(cell);
        });
    });
    
    // Update top grid
    updateOwnerSummary(ownerId, ownerName, totalLitre, ownerData.length);
    
    // Show message if no data
    if (ownerData.length === 0) {
        const messageCell = document.createElement("div");
        messageCell.style.gridColumn = "1 / span 5";
        messageCell.style.textAlign = "center";
        messageCell.style.padding = "20px";
        messageCell.style.color = "#666";
        messageCell.textContent = `No oil records found for ${ownerName}`;
        table.appendChild(messageCell);
    }
    
    console.log(`Loaded ${ownerData.length} records for ${ownerName}, Total: ${totalLitre}L`);
}

/* ========== UPDATE OWNER SUMMARY CALCULATIONS ========== */
function updateOwnerSummary(ownerId, ownerName, totalLitre, recordCount) {
    const page = document.getElementById(ownerId);
    if (!page) return;
    
    // Update basic info
    const ownerInput = page.querySelector('#owner-' + ownerId);
    if (ownerInput) ownerInput.value = ownerName;
    
    const totalInput = page.querySelector('#total-' + ownerId);
    if (totalInput) totalInput.value = totalLitre.toFixed(2);
    
    // Get rate and calculate amount
    const rateInput = page.querySelector('#rate-' + ownerId);
    const amountInput = page.querySelector('#amount-' + ownerId);
    
    if (rateInput && amountInput) {
        // Auto-calculate amount when rate changes
        rateInput.addEventListener('input', function() {
            const rate = parseFloat(this.value) || 0;
            const amount = totalLitre * rate;
            amountInput.value = amount.toFixed(2);
            saveOwnerRate(ownerId, rate, amount);
        });
        
        // Load saved rate
        const savedData = JSON.parse(localStorage.getItem(`owner_${ownerId}_rate`)) || {};
        if (savedData.rate) {
            rateInput.value = savedData.rate;
            amountInput.value = (totalLitre * savedData.rate).toFixed(2);
        }
    }
}

/* ========== SAVE RATE TO LOCALSTORAGE ========== */
function saveOwnerRate(ownerId, rate, amount) {
    localStorage.setItem(`owner_${ownerId}_rate`, JSON.stringify({
        rate: rate,
        amount: amount,
        savedAt: new Date().toISOString()
    }));
}

/* ========== PDF EXPORT FUNCTION ========== */
function exportToPDF(ownerId, ownerName) {
    const params = new URLSearchParams(window.location.search);
    const fileID = params.get("id") || "default";
    const masterKey = `oilOwnerMaster_${fileID}`;
    
    const masterData = JSON.parse(localStorage.getItem(masterKey)) || [];
    const ownerData = masterData.filter(record => 
        record.owner && record.owner.toLowerCase() === ownerName.toLowerCase()
    );
    
    if (ownerData.length === 0) {
        alert(`No data found for ${ownerName}`);
        return;
    }
    
    // Sort by date
    ownerData.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Calculate totals
    let totalLitre = 0;
    ownerData.forEach(record => {
        totalLitre += parseFloat(record.litre) || 0;
    });
    
    // Get rate and amount
    const page = document.getElementById(ownerId);
    const rateInput = page.querySelector('#rate-' + ownerId);
    const rate = rateInput ? parseFloat(rateInput.value) || 0 : 0;
    const amount = totalLitre * rate;
    
    // Create PDF content
    const pdfContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${ownerName} - Oil Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                th { background-color: #f2f2f2; }
                .summary { margin-top: 30px; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; }
                .total { font-weight: bold; color: #d9534f; }
            </style>
        </head>
        <body>
            <h1>Oil Report - ${ownerName}</h1>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>File ID:</strong> ${fileID}</p>
            
            <table>
                <thead>
                    <tr>
                        <th>Memo</th>
                        <th>Drum</th>
                        <th>Date</th>
                        <th>Vehicle</th>
                        <th>Litre</th>
                    </tr>
                </thead>
                <tbody>
                    ${ownerData.map(record => `
                        <tr>
                            <td>${record.memo || ""}</td>
                            <td>${record.drum || ""}</td>
                            <td>${formatDateToDDMMYYYY(record.date)}</td>
                            <td>${record.vehicle || ""}</td>
                            <td>${record.litre || "0"}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="summary">
                <h3>Summary</h3>
                <p><strong>Total Records:</strong> ${ownerData.length}</p>
                <p><strong>Total Litre:</strong> <span class="total">${totalLitre.toFixed(2)} L</span></p>
                <p><strong>Rate:</strong> â‚¹${rate.toFixed(2)} per litre</p>
                <p><strong>Total Amount:</strong> <span class="total">â‚¹${amount.toFixed(2)}</span></p>
            </div>
        </body>
        </html>
    `;
    
    // Open print dialog for PDF
    const printWindow = window.open('', '_blank');
    printWindow.document.write(pdfContent);
    printWindow.document.close();
    printWindow.focus();
    
    // Auto print after delay
    setTimeout(() => {
        printWindow.print();
    }, 500);
}

/* ========== DROPDOWN MENU ========== */
function toggleDropdown() {
    const menu = document.getElementById("dropdownMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function openPage(id, ownerName) {
    document.getElementById("dropdownMenu").style.display = "none";
    
    // Hide all pages
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    
    // Show selected page
    const page = document.getElementById(id);
    if (page) {
        page.style.display = "block";
        
        // Load owner data
        setTimeout(() => {
            loadOwnerFromOil(ownerName);
        }, 100);
    }
}

// Close dropdown when clicking outside
window.onclick = function(e) {
    if (!e.target.closest(".dropdown")) {
        document.getElementById("dropdownMenu").style.display = "none";
    }
}

/* ========== REAL-TIME UPDATES ========== */
function setupRealTimeListener() {
    const params = new URLSearchParams(window.location.search);
    const fileID = params.get("id") || "default";
    const masterKey = `oilOwnerMaster_${fileID}`;
    
    // Listen for storage changes
    window.addEventListener('storage', function(e) {
        if (e.key === masterKey) {
            // Reload data for active owner
            const activePages = document.querySelectorAll('.page');
            let activeOwner = null;
            
            activePages.forEach(page => {
                if (page.style.display === 'block') {
                    activeOwner = page.id;
                }
            });
            
            if (activeOwner) {
                const ownerName = activeOwner.charAt(0).toUpperCase() + activeOwner.slice(1);
                loadOwnerFromOil(ownerName);
            }
        }
    });
    
    // Auto-refresh every 3 seconds
    setInterval(() => {
        const activePages = document.querySelectorAll('.page');
        let activeOwner = null;
        
        activePages.forEach(page => {
            if (page.style.display === 'block') {
                activeOwner = page.id;
            }
        });
        
        if (activeOwner) {
            const ownerName = activeOwner.charAt(0).toUpperCase() + activeOwner.slice(1);
            loadOwnerFromOil(ownerName);
        }
    }, 3000);
}

/* ========== INITIALIZE ON PAGE LOAD ========== */
window.addEventListener('DOMContentLoaded', function() {
    setupRealTimeListener();
    
    // Open default page (Athar)
    openPage("athar", "Athar");
});
</script>

</body>
</html>